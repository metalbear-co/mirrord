Some agent code housekeeping, including improved tracing and errors and removal of index allocator.
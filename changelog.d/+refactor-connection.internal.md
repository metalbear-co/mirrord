Reduce some code duplication around protocol and agent connection.

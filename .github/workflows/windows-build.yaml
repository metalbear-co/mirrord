name: Windows Build

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Pick artifacts from GCS (reuse) or build & sign now"
        type: choice
        options: [build_sign, reuse]
        default: build_sign
      release:
        description: "Publish a GitHub Release?"
        type: choice
        options: [no, draft, prerelease, release]
        default: no
      release_tag:
        description: "Release tag"
        required: false
        type: string
      sign_artifacts:
        description: "Code-sign EXE & DLL"
        type: choice
        options: ["false", "true"]
        default: false

  push:
    paths-ignore:
      - "*.md"
      - "**/*.md"

  pull_request:
    branches: ["main", "*staging*", "windows-support"]
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "*.md"
      - "**/*.md"

permissions:
  contents: write

env:
  BUCKET_URI: gs://mirrord-windows-builds
  ARTIFACT_SUBPATH: windows/mirrord-3.163.0-run70-0932953
  MSI_BUCKET_URI: gs://mirrord-windows-msi
  RUST_BACKTRACE: "1"
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"
  MIRRORD_TELEMETRY: "false"
  LIBCLANG_PATH: "C:\\Program Files\\LLVM\\bin"

jobs:
  windows_tests:
    runs-on: [self-hosted, Windows]
    defaults:
      run:
        shell: pwsh
    env:
      MODE: ${{ github.event.inputs.mode || 'build_sign' }}
      PUBLISH_MODE: ${{ github.event.inputs.release || 'no' }}
      RELEASE_TAG_INPUT: ${{ github.event.inputs.release_tag || '' }}
      SIGN_ARTIFACTS: ${{ github.event.inputs.sign_artifacts || 'false' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Toolchain info
        run: |
          rustc -V
          cargo -V
          whoami

      # ----------------------------
      #  DOWNLOAD OR BUILD ARTIFACTS
      # ----------------------------
      - name: Prepare artifacts
        id: prep
        run: |
          $ErrorActionPreference = "Stop"

          function Set-Env ($k,$v){ "$k=$v" | Out-File -FilePath $env:GITHUB_ENV -Append }

          $Target = "x86_64-pc-windows-msvc"
          $Tmp = Join-Path $env:RUNNER_TEMP "prep"
          New-Item -ItemType Directory -Force -Path $Tmp | Out-Null

          if ($env:MODE -eq "reuse") {
            Write-Host "⚡ Reusing artifacts from GCS"

            $dest = Join-Path $Tmp "gcs"
            New-Item -ItemType Directory -Force -Path $dest | Out-Null

            gcloud --quiet storage cp "$($env:BUCKET_URI)/$($env:ARTIFACT_SUBPATH)/*" $dest/

            $exe = Join-Path $dest "mirrord.exe"
            $dll = Join-Path $dest "mirrord_layer_win.dll"

            Set-Env MIRRORD_EXE $exe
            Set-Env MIRRORD_LAYER_FILE $dll
            Set-Env MIRRORD_VERSION "0.0.0"
            exit 0
          }

          Write-Host "⚙️ Building artifacts"

          rustup target add $Target

          cargo build -p mirrord-layer-win --target $Target --release
          cargo build -p mirrord --bin mirrord --target $Target --release

          $dll = "target/$Target/release/mirrord_layer_win.dll"
          $exe = "target/$Target/release/mirrord.exe"

          if ($env:SIGN_ARTIFACTS -eq "true") {
            & signtool.exe sign /sha1 bfa0bea8d22265cb382d2d5dec55a6ffcff70bcb /tr http://timestamp.digicert.com /td SHA256 /fd SHA256 $dll
            & signtool.exe sign /sha1 bfa0bea8d22265cb382d2d5dec55a6ffcff70bcb /tr http://timestamp.digicert.com /td SHA256 /fd SHA256 $exe
          }

          # Compute SHA256
          foreach ($f in @($exe,$dll)) {
            $h = (Get-FileHash -Algorithm SHA256 $f).Hash
            "$h  $(Split-Path $f -Leaf)" | Out-File -FilePath "$f.sha256"
          }

          $version = (cargo metadata --format-version 1 | ConvertFrom-Json).packages |
            Where-Object { $_.name -eq "mirrord" } |
            Select-Object -ExpandProperty version

          Set-Env MIRRORD_VERSION $version
          Set-Env MIRRORD_EXE $exe
          Set-Env MIRRORD_LAYER_FILE $dll

      # ----------------------------
      #  BUILD SIMPLE MSI INSTALLER
      # ----------------------------
      - name: Build MSI
        run: |
          $ErrorActionPreference = "Stop"

          $version = $env:MIRRORD_VERSION
          $Root = "C:\wix\mirrord"
          $Src = Join-Path $Root "src"
          $Out = Join-Path $Root "out"

          New-Item -ItemType Directory -Force -Path $Src,$Out | Out-Null

          Copy-Item $env:MIRRORD_EXE  "$Src\mirrord.exe" -Force
          Copy-Item $env:MIRRORD_LAYER_FILE "$Src\mirrord_layer_win.dll" -Force

          Copy-Item "mirrord/cli/wix/mirrord.ico" "$Src\mirrord.ico" -Force
          Copy-Item "mirrord/cli/wix/License.rtf" "$Src\License.rtf" -Force

          $wxsPath = Join-Path $Root "ProductSimple.wxs"

          @"
<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" Name="mirrord" Manufacturer="MetalBear" Language="1033" Version="$version" UpgradeCode="EAFD3591-E78C-4B78-85BF-5FE0E72BB7A2">
    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine"
             Description="Run a local process in the context of a cloud environment" />

    <MediaTemplate />

    <Property Id="ARPPRODUCTICON" Value="ProductICO"/>
    <Property Id="ARPHELPLINK"   Value="https://metalbear.co/mirrord/docs"/>

    <Icon Id="ProductICO" SourceFile="mirrord.ico"/>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="InstallDir" Name="mirrord"/>
      </Directory>
    </Directory>

    <ComponentGroup Id="InstallFiles" Directory="InstallDir">
      <Component Id="MirrordExe" Guid="*">
        <File Id="ExeFile" Source="mirrord.exe" KeyPath="yes"/>
      </Component>
      <Component Id="MirrordDll" Guid="*">
        <File Id="DllFile" Source="mirrord_layer_win.dll" KeyPath="yes"/>
      </Component>
    </ComponentGroup>

    <Feature Id="MainFeature" Title="mirrord" Level="1">
      <ComponentGroupRef Id="InstallFiles"/>
    </Feature>

    <UI>
      <UIRef Id="WixUI_Minimal"/>
    </UI>

    <WixVariable Id="WixUILicenseRtf" Value="License.rtf"/>
  </Product>
</Wix>
"@ | Set-Content -Path $wxsPath -Encoding UTF8

          $candle = (Get-ChildItem 'C:\Program Files (x86)\WiX Toolset v3.*\bin\candle.exe')[0].FullName
          $light  = (Get-ChildItem 'C:\Program Files (x86)\WiX Toolset v3.*\bin\light.exe')[0].FullName

          $obj = Join-Path $Out "ProductSimple.wixobj"
          $msi = Join-Path $Out "mirrord-$version.msi"

          & $candle -nologo -dSrc=$Src -ext WixUIExtension -out $obj $wxsPath
          & $light -nologo -ext WixUIExtension -out $msi $obj

          $sha = "$msi.sha256"
          $h = (Get-FileHash -Algorithm SHA256 $msi).Hash
          "$h  $(Split-Path $msi -Leaf)" | Out-File -FilePath $sha

          "MSI_PATH=$msi" | Out-File -FilePath $env:GITHUB_ENV -Append
          "MSI_SHA256_PATH=$sha" | Out-File -FilePath $env:GITHUB_ENV -Append

      # ----------------------------
      #  UPLOAD MSI TO GCS
      # ----------------------------
      - name: Upload MSI to GCS
        run: |
          $version = $env:MIRRORD_VERSION
          $sha7 = $env:GITHUB_SHA.Substring(0,7)
          $dest = "$env:MSI_BUCKET_URI/msi/mirrord-$version-$sha7/"
          gcloud --quiet storage cp $env:MSI_PATH $dest
          gcloud --quiet storage cp $env:MSI_SHA256_PATH $dest

      # ----------------------------
      #  GITHUB RELEASE
      # ----------------------------
      - name: Upload to GitHub Release
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/github-release@v1
        with:
          files: |
            ${{ env.MSI_PATH }}
            ${{ env.MSI_SHA256_PATH }}

name: Windows Build

on:
  workflow_dispatch:
    inputs:
      github_release:
        description: "Create/attach a GitHub Release?"
        type: choice
        options: [no, draft, prerelease, release]
        default: no
      release_tag:
        description: "Release tag (defaults to pushed tag when running on a tag)"
        required: false
        type: string
      chocolatey_release:
        description: "Publish a Chocolatey package?"
        type: choice
        options: ["false", "true"]
        default: "false"
      winget_release:
        description: "Publish a WinGet package?"
        type: choice
        options: ["false", "true"]
        default: "false"

  pull_request:
    branches: ["main", "*staging*", "windows-support"]
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "*.md"
      - "**/*.md"

permissions:
  contents: write

env:
  DIST_DIR: dist/windows

jobs:
  windows-build:
    name: Build & Package (Windows)
    runs-on: windows-latest

    steps:
      # ----------------------------------------------------------
      # 1) Checkout
      # ----------------------------------------------------------
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # 2) (Optional) Show tool versions (debug)
      # ----------------------------------------------------------
      - name: Show tool versions
        id: versions
        shell: pwsh
        continue-on-error: true
        run: |
          $ErrorActionPreference = "Continue"
          Write-Host "rustc version:"
          try { rustc --version } catch { Write-Host "rustc not found" }
          Write-Host "cargo version:"
          try { cargo --version } catch { Write-Host "cargo not found" }
          Write-Host "choco version:"
          try { choco --version } catch { Write-Host "choco not found" }
          Write-Host "gh version:"
          try { gh --version } catch { Write-Host "gh not found" }

      # ----------------------------------------------------------
      # 3) Build mirrord_layer_win.dll and mirrord.exe
      #    (Fixes MIRRORD_LAYER_FILE include_bytes! error)
      # ----------------------------------------------------------
      - name: Build mirrord (Windows)
        id: build
        shell: pwsh
        continue-on-error: true
        run: |
          $ErrorActionPreference = "Stop"

          Write-Host "=== Building mirrord_layer_win.dll ==="
          # Adjust package name if needed
          cargo build --locked --release -p mirrord_layer_win

          $layerPath = "target\\release\\mirrord_layer_win.dll"
          if (-not (Test-Path $layerPath)) {
            throw "Expected layer DLL not found at $layerPath"
          }

          Write-Host "=== Building mirrord.exe with MIRRORD_LAYER_FILE ==="
          $env:MIRRORD_LAYER_FILE = $layerPath
          cargo build --locked --release --bin mirrord

          $exePath = "target\\release\\mirrord.exe"
          if (-not (Test-Path $exePath)) {
            throw "Expected mirrord.exe not found at $exePath"
          }

          Write-Host "=== Preparing dist directory ==="
          New-Item -ItemType Directory -Force -Path "$env:DIST_DIR" | Out-Null

          Copy-Item $exePath "$env:DIST_DIR\\mirrord.exe"
          Copy-Item $layerPath "$env:DIST_DIR\\mirrord_layer_win.dll"

      # ----------------------------------------------------------
      # 4) Run tests (workspace)
      # ----------------------------------------------------------
      - name: Run tests
        id: test
        shell: pwsh
        continue-on-error: true
        run: |
          $ErrorActionPreference = "Stop"
          cargo test --locked --workspace

      # ----------------------------------------------------------
      # 5) Package ZIP from dist directory
      # ----------------------------------------------------------
      - name: Package ZIP
        id: package_zip
        shell: pwsh
        continue-on-error: true
        run: |
          $ErrorActionPreference = "Stop"

          if (-not (Test-Path "$env:DIST_DIR")) {
            throw "DIST_DIR '$env:DIST_DIR' does not exist; build may have failed."
          }

          $zipPath = "$env:DIST_DIR\\mirrord_windows.zip"
          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }

          Compress-Archive -Path "$env:DIST_DIR\\*" -DestinationPath $zipPath

          if (-not (Test-Path $zipPath)) {
            throw "Failed to create ZIP at $zipPath"
          }

      # ----------------------------------------------------------
      # 6) Upload build artifacts for later inspection
      # ----------------------------------------------------------
      - name: Upload build artifacts
        id: upload_artifact
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: mirrord-windows
          path: ${{ env.DIST_DIR }}

      # ----------------------------------------------------------
      # 7) (Toggle) Publish to Chocolatey
      #     - expects CHOCOLATEY_API_KEY secret
      #     - expects .\packaging\choco\mirrord.nuspec (adjust path if needed)
      # ----------------------------------------------------------
      - name: Publish to Chocolatey
        id: chocolatey
        if: github.event_name == 'workflow_dispatch' && inputs.chocolatey_release == 'true'
        shell: pwsh
        continue-on-error: true
        env:
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
        run: |
          $ErrorActionPreference = "Stop"

          if (-not $env:CHOCOLATEY_API_KEY) {
            throw "CHOCOLATEY_API_KEY secret is not set."
          }

          Write-Host "=== Packing Chocolatey nupkg ==="
          choco pack .\packaging\choco\mirrord.nuspec --outputdirectory "$env:DIST_DIR"

          $nupkg = Get-ChildItem "$env:DIST_DIR" -Filter "*.nupkg" | Select-Object -First 1
          if (-not $nupkg) {
            throw "No .nupkg found in $env:DIST_DIR after choco pack."
          }

          Write-Host "=== Pushing to Chocolatey ==="
          choco apiKey -k $env:CHOCOLATEY_API_KEY -s https://push.chocolatey.org/
          choco push $nupkg.FullName -s https://push.chocolatey.org/ --skip-virus-check

      # ----------------------------------------------------------
      # 8) (Toggle) Publish to WinGet
      #     - expects WINGET_GITHUB_TOKEN secret
      #     - adjust commands to your actual WinGet flow
      # ----------------------------------------------------------
      - name: Publish to WinGet
        id: winget
        if: github.event_name == 'workflow_dispatch' && inputs.winget_release == 'true'
        shell: pwsh
        continue-on-error: true
        env:
          WINGET_GITHUB_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"

          if (-not $env:WINGET_GITHUB_TOKEN) {
            throw "WINGET_GITHUB_TOKEN secret is not set."
          }

          Write-Host "=== WinGet publish (example ‚Äì adjust to your setup) ==="
          Write-Host "This step assumes you've configured wingetcreate/manifests elsewhere."
          Write-Host "Version: ${{ github.event_name == 'workflow_dispatch' && inputs.release_tag || 'N/A' }}"

          # TODO: replace this with your real WinGet automation.
          Write-Host "WinGet publish placeholder completed."

      # ----------------------------------------------------------
      # 9) (Toggle) Create / Update GitHub Release and attach assets
      #     - uses built-in gh CLI instead of external actions
      # ----------------------------------------------------------
      - name: Create / Update GitHub Release
        id: github_release
        if: github.event_name == 'workflow_dispatch' && inputs.github_release != 'no'
        shell: bash
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DIST_DIR: ${{ env.DIST_DIR }}
          RELEASE_KIND: ${{ inputs.github_release }}
          INPUT_TAG: ${{ inputs.release_tag }}
        run: |
          set -euo pipefail

          if [[ -z "${GITHUB_TOKEN:-}" ]]; then
            echo "GITHUB_TOKEN is not available."
            exit 1
          fi

          # Determine tag:
          if [[ -n "$INPUT_TAG" ]]; then
            TAG="$INPUT_TAG"
          elif [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            echo "No release_tag input and not running on a tag ref; cannot create release."
            exit 1
          fi

          NAME="mirrord $TAG"

          FLAGS=()
          if [[ "$RELEASE_KIND" == "draft" ]]; then
            FLAGS+=(--draft)
          elif [[ "$RELEASE_KIND" == "prerelease" ]]; then
            FLAGS+=(--prerelease)
          fi

          echo "=== Ensuring GitHub Release '$TAG' exists ==="
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists; reusing."
          else
            gh release create "$TAG" "${FLAGS[@]}" \
              --title "$NAME" \
              --notes "Automated Windows build for $TAG."
          fi

          echo "=== Uploading assets from $DIST_DIR ==="
          if [[ ! -d "$DIST_DIR" ]]; then
            echo "DIST_DIR '$DIST_DIR' does not exist."
            exit 1
          fi

          if [[ -f "$DIST_DIR/mirrord.exe" ]]; then
            gh release upload "$TAG" "$DIST_DIR/mirrord.exe" --clobber
          else
            echo "Warning: $DIST_DIR/mirrord.exe not found."
          fi

          if [[ -f "$DIST_DIR/mirrord_layer_win.dll" ]]; then
            gh release upload "$TAG" "$DIST_DIR/mirrord_layer_win.dll" --clobber
          else
            echo "Warning: $DIST_DIR/mirrord_layer_win.dll not found."
          fi

          if [[ -f "$DIST_DIR/mirrord_windows.zip" ]]; then
            gh release upload "$TAG" "$DIST_DIR/mirrord_windows.zip" --clobber
          else
            echo "Warning: $DIST_DIR/mirrord_windows.zip not found."
          fi


      # -------------------------------------------------------
      # Post-build summary (Summary tab)
      # -------------------------------------------------------
      - name: Post-build summary
        if: always()
        shell: pwsh
        run: |
          $summary = $env:GITHUB_STEP_SUMMARY

          "## Windows Build Summary"        | Out-File -FilePath $summary -Encoding utf8 -Append
          ""                                | Out-File -FilePath $summary -Encoding utf8 -Append
          "**Overall job status:** `${{ job.status }}`" |
            Out-File -FilePath $summary -Encoding utf8 -Append
          ""                                | Out-File -FilePath $summary -Encoding utf8 -Append

          "| Stage | Status | Details |"     | Out-File -FilePath $summary -Encoding utf8 -Append
          "|-------|--------|---------|"     | Out-File -FilePath $summary -Encoding utf8 -Append

          # üîß Build & sign
          "| Build & sign binaries | ${{ steps.build_and_sign.outcome || 'skipped' }} | cargo + signing |" |
            Out-File -FilePath $summary -Encoding utf8 -Append

          # üì¶ MSI
          "| Build MSI | ${{ steps.build_msi.outcome || 'skipped' }} | WiX / .msi packaging |" |
            Out-File -FilePath $summary -Encoding utf8 -Append

          # ‚òÅÔ∏è Uploads to GCS
          "| Upload MSI to GCS | ${{ steps.upload_msi_gcs.outcome || 'skipped' }} | ${{ env.MSI_BUCKET_URI }} |" |
            Out-File -FilePath $summary -Encoding utf8 -Append

          "| Upload ZIP/binaries to GCS | ${{ steps.upload_zip_gcs.outcome || 'skipped' }} | ${{ env.BUCKET_URI }} |" |
            Out-File -FilePath $summary -Encoding utf8 -Append

          # üç´ Chocolatey (toggled)
          "| Chocolatey package | ${{ steps.choco_pack.outcome || 'skipped' }} | nupkg creation (toggle: ${{ env.INPUT_PUBLISH_CHOCO }}) |" |
            Out-File -FilePath $summary -Encoding utf8 -Append

          "| Push to Chocolatey feed | ${{ steps.choco_push.outcome || 'skipped' }} | internal/external feed |" |
            Out-File -FilePath $summary -Encoding utf8 -Append

          # ü™ü WinGet (toggled)
          "| Generate WinGet manifest | ${{ steps.winget_generate.outcome || 'skipped' }} | yaml manifest (toggle: ${{ env.INPUT_PUBLISH_WINGET }}) |" |
            Out-File -FilePath $summary -Encoding utf8 -Append

          "| Publish WinGet package | ${{ steps.winget_publish.outcome || 'skipped' }} | submit to repo |" |
            Out-File -FilePath $summary -Encoding utf8 -Append

          # üè∑Ô∏è GitHub Release
          "| Ensure GitHub Release exists | ${{ steps.ensure_release.outcome || 'skipped' }} | create/find release |" |
            Out-File -FilePath $summary -Encoding utf8 -Append

          "| Attach artifacts to Release | ${{ steps.attach_release_assets.outcome || 'skipped' }} | upload assets |" |
            Out-File -FilePath $summary -Encoding utf8 -Append

          # üß™ Release validation tests
          "| Release validation tests | ${{ steps.release_tests.outcome || 'skipped' }} | curl/brew checks etc. |" |
            Out-File -FilePath $summary -Encoding utf8 -Append

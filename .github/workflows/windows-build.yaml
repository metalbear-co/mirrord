name: Windows Build

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Pick artifacts from GCS (reuse) or build & sign now"
        type: choice
        options: [build_sign, reuse]
        default: build_sign
      release:
        description: "Publish a GitHub Release?"
        type: choice
        options: [no, draft, prerelease, release]
        default: no
      release_tag:
        description: "Release tag"
        required: false
        type: string
      sign_artifacts:
        description: "Code-sign EXE & DLL"
        type: choice
        options: ["false", "true"]
        default: false

  push:
    paths-ignore:
      - "*.md"
      - "**/*.md"

  pull_request:
    branches: ["main", "*staging*", "windows-support"]
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "*.md"
      - "**/*.md"

permissions:
  contents: write

env:
  BUCKET_URI: gs://mirrord-windows-builds
  ARTIFACT_SUBPATH: windows/mirrord-3.163.0-run70-0932953
  MSI_BUCKET_URI: gs://mirrord-windows-msi
  RUST_BACKTRACE: "1"
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"
  MIRRORD_TELEMETRY: "false"
  LIBCLANG_PATH: "C:\\Program Files\\LLVM\\bin"

jobs:
  windows_tests:
    runs-on: [self-hosted, Windows]
    defaults:
      run:
        shell: pwsh
    env:
      MODE: ${{ github.event.inputs.mode || 'build_sign' }}
      PUBLISH_MODE: ${{ github.event.inputs.release || 'no' }}
      RELEASE_TAG_INPUT: ${{ github.event.inputs.release_tag || '' }}
      SIGN_ARTIFACTS: ${{ github.event.inputs.sign_artifacts || 'false' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Toolchain info
        run: |
          rustc -V
          cargo -V
          whoami

      # ----------------------------
      #  DOWNLOAD OR BUILD ARTIFACTS
      # ----------------------------
      - name: Prepare artifacts
        id: prep
        run: |
          $ErrorActionPreference = "Stop"

          function Set-Env ($k,$v){ "$k=$v" | Out-File -FilePath $env:GITHUB_ENV -Append }

          $Target = "x86_64-pc-windows-msvc"
          $Tmp = Join-Path $env:RUNNER_TEMP "prep"
          New-Item -ItemType Directory -Force -Path $Tmp | Out-Null

          if ($env:MODE -eq "reuse") {
            Write-Host "⚡ Reusing artifacts from GCS"

            $dest = Join-Path $Tmp "gcs"
            New-Item -ItemType Directory -Force -Path $dest | Out-Null

            gcloud --quiet storage cp "$($env:BUCKET_URI)/$($env:ARTIFACT_SUBPATH)/*" $dest/

            $exe = Join-Path $dest "mirrord.exe"
            $dll = Join-Path $dest "mirrord_layer_win.dll"

            Set-Env MIRRORD_EXE $exe
            Set-Env MIRRORD_LAYER_FILE $dll
            Set-Env MIRRORD_VERSION "0.0.0"
            exit 0
          }

          Write-Host "⚙️ Building artifacts"

          rustup target add $Target

          cargo build -p mirrord-layer-win --target $Target --release
          cargo build -p mirrord --bin mirrord --target $Target --release

          $dll = "target/$Target/release/mirrord_layer_win.dll"
          $exe = "target/$Target/release/mirrord.exe"

          if ($env:SIGN_ARTIFACTS -eq "true") {
            & signtool.exe sign /sha1 bfa0bea8d22265cb382d2d5dec55a6ffcff70bcb /tr http://timestamp.digicert.com /td SHA256 /fd SHA256 $dll
            & signtool.exe sign /sha1 bfa0bea8d22265cb382d2d5dec55a6ffcff70bcb /tr http://timestamp.digicert.com /td SHA256 /fd SHA256 $exe
          }

          foreach ($f in @($exe,$dll)) {
            $h = (Get-FileHash -Algorithm SHA256 $f).Hash
            "$h  $(Split-Path $f -Leaf)" | Out-File -FilePath "$f.sha256"
          }

          $version = (cargo metadata --format-version 1 | ConvertFrom-Json).packages |
            Where-Object { $_.name -eq "mirrord" } |
            Select-Object -ExpandProperty version

          Set-Env MIRRORD_VERSION $version
          Set-Env MIRRORD_EXE $exe
          Set-Env MIRRORD_LAYER_FILE $dll

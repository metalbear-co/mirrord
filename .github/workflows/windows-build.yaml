name: Windows Build

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Pick artifacts from GCS (reuse) or build & sign now"
        type: choice
        options: [build_sign, reuse]
        default: build_sign
      release:
        description: "Publish a GitHub Release?"
        type: choice
        options: [no, draft, prerelease, release]
        default: no
      release_tag:
        description: "Release tag (defaults to pushed tag or v<MIRRORD_VERSION>)"
        required: false
        type: string
      sign_artifacts:
        description: "Code-sign EXE & DLL"
        type: choice
        options: ["false", "true"]
        default: false

  push:
    paths-ignore:
      - "*.md"
      - "**/*.md"

  pull_request:
    branches: ["main", "*staging*", "windows-support"]
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "*.md"
      - "**/*.md"

permissions:
  contents: write

env:
  BUCKET_URI: gs://mirrord-windows-builds
  ARTIFACT_SUBPATH: windows/mirrord-3.163.0-run70-0932953
  MSI_BUCKET_URI: gs://mirrord-windows-msi
  RUST_BACKTRACE: "1"
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"
  MIRRORD_TELEMETRY: "false"
  LIBCLANG_PATH: "C:\\Program Files\\LLVM\\bin"

jobs:
  windows_tests:
    runs-on: [self-hosted, Windows]
    defaults:
      run:
        shell: pwsh
    env:
      MODE: ${{ github.event.inputs.mode || 'build_sign' }}
      PUBLISH_MODE: ${{ github.event.inputs.release || 'no' }}
      RELEASE_TAG_INPUT: ${{ github.event.inputs.release_tag || '' }}
      SIGN_ARTIFACTS: ${{ github.event.inputs.sign_artifacts || 'false' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Toolchain info
        run: |
          $ErrorActionPreference = 'Stop'
          whoami
          rustc -V
          cargo -V
          rustup show

      ##########################################################################
      #  ARTIFACTS PREP (Build or download existing)
      ##########################################################################
      - name: Prepare artifacts
        id: prep
        run: |
          $ErrorActionPreference = 'Stop'
          function Set-Env([string]$k,[string]$v){ "$k=$v" | Out-File -FilePath $env:GITHUB_ENV -Append }

          $Target = "x86_64-pc-windows-msvc"
          $CargoTargetDir = Join-Path $env:GITHUB_WORKSPACE "target"
          $Dbg = Join-Path $CargoTargetDir "$Target\debug"
          $Rel = Join-Path $CargoTargetDir "$Target\release"

          $Tmp = Join-Path $env:RUNNER_TEMP "prep"
          New-Item -ItemType Directory -Force -Path $Tmp | Out-Null

          $shouldSign = [System.String]::Equals($env:SIGN_ARTIFACTS,'true','InvariantCultureIgnoreCase')

          if ($env:MODE -eq 'reuse') {
            if (-not (Get-Command gcloud -ErrorAction SilentlyContinue)) {
              throw "gcloud missing"
            }
            $dest = Join-Path $Tmp "picked"
            New-Item -ItemType Directory -Force -Path $dest | Out-Null

            gcloud --quiet storage cp "$($env:BUCKET_URI)/$($env:ARTIFACT_SUBPATH)/*" "$dest/"
            if ($LASTEXITCODE -ne 0) { throw "gcloud cp failed" }

            $exe = (Get-ChildItem $dest -Recurse -Filter "mirrord.exe" | Select-Object -First 1).FullName
            $dll = (Get-ChildItem $dest -Recurse -Filter "mirrord_layer_win.dll" | Select-Object -First 1).FullName
            if (-not $dll) { $dll = (Get-ChildItem $dest -Recurse -Filter "mirrord-layer-win.dll" | Select-Object -First 1).FullName }

            if (-not ($exe -and $dll)) { throw "Missing exe/dll in reuse mode" }

            if ($shouldSign) {
              & signtool.exe sign /sha1 bfa0bea8d22265cb382d2d5dec55a6ffcff70bcb /fd SHA256 /td SHA256 /tr http://timestamp.digicert.com "$dll"
              & signtool.exe sign /sha1 bfa0bea8d22265cb382d2d5dec55a6ffcff70bcb /fd SHA256 /td SHA256 /tr http://timestamp.digicert.com "$exe"
            }

            Set-Env MIRRORD_EXE $exe
            Set-Env MIRRORD_LAYER_FILE $dll
            Set-Env MIRRORD_VERSION "unknown"
            exit 0
          }

          rustup target add $Target

          cargo build -p mirrord-layer-win --target $Target
          $dll = if (Test-Path (Join-Path $Dbg "mirrord_layer_win.dll")) { Join-Path $Dbg "mirrord_layer_win.dll" } else { Join-Path $Rel "mirrord_layer_win.dll" }

          if ($shouldSign) {
            & signtool.exe sign /sha1 bfa0bea8d22265cb382d2d5dec55a6ffcff70bcb /fd SHA256 /td SHA256 /tr http://timestamp.digicert.com "$dll"
          }

          $env:MIRRORD_LAYER_FILE = $dll

          $meta = cargo metadata --format-version 1 --no-deps | ConvertFrom-Json
          $pkg  = $meta.packages | Where-Object { $_.name -eq "mirrord" } | Select-Object -First 1

          cargo build -p mirrord --bin mirrord --target $Target
          $exe = if (Test-Path (Join-Path $Dbg "mirrord.exe")) { Join-Path $Dbg "mirrord.exe" } else { Join-Path $Rel "mirrord.exe" }

          if ($shouldSign) {
            & signtool.exe sign /sha1 bfa0bea8d22265cb382d2d5dec55a6ffcff70bcb /fd SHA256 /td SHA256 /tr http://timestamp.digicert.com "$exe"
          }

          Set-Env MIRRORD_EXE $exe
          Set-Env MIRRORD_LAYER_FILE $dll
          Set-Env MIRRORD_VERSION $pkg.version
          Set-Env MIRRORD_PKG $pkg.name

      ##########################################################################
      #  MSI BUILD FROM REPO MAIN.WXS  (A2 MODE)
      ##########################################################################
      - name: Build MSI (WiX, using repo main.wxs)
        run: |
          $ErrorActionPreference = "Stop"

          $wxsRoot = Join-Path $env:GITHUB_WORKSPACE "mirrord/cli/wix"
          $wxsPath = Join-Path $wxsRoot "main.wxs"
          $icon    = Join-Path $wxsRoot "mirrord.ico"
          $rtf     = Join-Path $wxsRoot "License.rtf"

          if (-not (Test-Path $wxsPath)) { throw "Missing main.wxs" }
          if (-not (Test-Path $icon))    { throw "Missing mirrord.ico" }
          if (-not (Test-Path $rtf))     { throw "Missing License.rtf" }

          $Target     = "x86_64-pc-windows-msvc"
          $CargoProfile = "release"
          $CargoTargetDir = Join-Path $env:GITHUB_WORKSPACE "target"
          $CargoTargetBinDir = Join-Path $CargoTargetDir "$Target\$CargoProfile"

          $Version = $env:MIRRORD_VERSION
          if (-not $Version -or $Version -eq "unknown") {
            $Version = "0.0.0"
          }

          $candle = (Get-ChildItem "C:\Program Files (x86)\WiX Toolset v3.*\bin\candle.exe" | Select-Object -First 1).FullName
          $light  = (Get-ChildItem "C:\Program Files (x86)\WiX Toolset v3.*\bin\light.exe"  | Select-Object -First 1).FullName

          if (-not $candle) { throw "candle.exe not found" }
          if (-not $light)  { throw "light.exe not found" }

          $OutDir = Join-Path $env:RUNNER_TEMP "msi"
          New-Item -ItemType Directory -Force -Path $OutDir | Out-Null

          $obj = Join-Path $OutDir "product.wixobj"
          $msi = Join-Path $OutDir ("mirrord-{0}.msi" -f $Version)

          & $candle `
            -nologo `
            -ext WixUIExtension `
            -dCargoTargetBinDir="$CargoTargetBinDir" `
            -dCargoTargetDir="$CargoTargetDir" `
            -dCargoProfile="$CargoProfile" `
            -dVersion="$Version" `
            -dTargetEnv="msvc" `
            -dTargetTriple="$Target" `
            -dTargetVendor="pc" `
            -out $obj `
            $wxsPath

          if ($LASTEXITCODE -ne 0 -or -not (Test-Path $obj)) { throw "Candle failed" }

          & $light `
            -nologo `
            -ext WixUIExtension `
            -out $msi `
            $obj

          if ($LASTEXITCODE -ne 0 -or -not (Test-Path $msi)) { throw "Light failed" }

          "MSI_PATH=$msi" | Out-File -FilePath $env:GITHUB_ENV -Append

          $sha = "$msi.sha256"
          $h = (Get-FileHash -Algorithm SHA256 $msi).Hash
          "$h  $(Split-Path $msi -Leaf)" | Out-File $sha -Encoding ascii
          "MSI_SHA256_PATH=$sha" | Out-File -FilePath $env:GITHUB_ENV -Append

      ##########################################################################
      # Upload MSI to GCS
      ##########################################################################
      - name: Upload MSI to GCS
        if: ${{ env.MSI_BUCKET_URI != '' }}
        run: |
          $ErrorActionPreference = "Stop"
          $msi = $env:MSI_PATH
          $sha = $env:MSI_SHA256_PATH
          if (-not (Test-Path $msi)) { throw "MSI missing" }

          $ver  = $env:MIRRORD_VERSION
          $sha7 = $env:GITHUB_SHA.Substring(0,7)
          $dest = "$($env:MSI_BUCKET_URI)/mirrord-$ver-$sha7/"

          gcloud --quiet storage cp $msi $dest
          gcloud --quiet storage cp $sha $dest

      ##########################################################################
      # Tests
      ##########################################################################
      - name: Run tests
        run: |
          $ErrorActionPreference = 'Stop'
          cargo test --target x86_64-pc-windows-msvc --workspace

      ##########################################################################
      # Compute Release Tag
      ##########################################################################
      - name: Compute release tag
        id: tag
        if: ${{ github.event_name != 'pull_request' && (startsWith(github.ref,'refs/tags/') || env.PUBLISH_MODE != 'no') }}
        run: |
          $ErrorActionPreference='Stop'
          if ("$env:GITHUB_REF".StartsWith("refs/tags/")) {
            $tag = "$env:GITHUB_REF".Substring(10)
          } elseif ($env:RELEASE_TAG_INPUT) {
            $tag = $env:RELEASE_TAG_INPUT
          } else {
            $tag = "v$($env:MIRRORD_VERSION)"
          }
          "RELEASE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Append

      ##########################################################################
      # Upload EXE/DLL/MSI to GitHub Release
      ##########################################################################
      - name: Upload to GitHub Release
        if: ${{ github.event_name != 'pull_request' && (startsWith(github.ref,'refs/tags/') || env.PUBLISH_MODE != 'no') }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ${{ env.MSI_PATH }}
          asset_name: mirrord-${{ env.MIRRORD_VERSION }}.msi
          asset_content_type: application/octet-stream

name: E2E Tests


on:
  workflow_call:
  pull_request:
    types: [labeled]
  workflow_dispatch:

permissions:
  contents: read

env:
  RUST_BACKTRACE: "1"
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"
  MIRRORD_TELEMETRY: "false"
  LIBCLANG_PATH: "C:\\Program Files\\LLVM\\bin"

jobs:
  windows_e2e:
    if: ${{ contains(github.event.pull_request.labels.*.name, 'windows-e2e') || github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call' }}
    permissions:
      contents: read
    runs-on: [self-hosted, Windows]
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Toolchain info
        run: |
          $ErrorActionPreference = "Stop"
          whoami
          rustc -V
          cargo -V
          rustup show

      - name: Prepare e2e tests dependencies
        run: |
          $ErrorActionPreference = "Stop"
          $ScriptsDir = Join-Path $env:GITHUB_WORKSPACE "scripts"
          & "$ScriptsDir\win_build_test_apps.ps1"

      - name: Ensure Python test deps (flask/uvicorn/fastapi)
        run: |
          $ErrorActionPreference = "Stop"
          $py = Get-Command py -ErrorAction SilentlyContinue
          if (-not $py) {
            throw "py launcher not found; ensure Python is installed."
          }
          py -3 -m pip install --upgrade pip
          py -3 -m pip install --upgrade flask uvicorn fastapi

      - name: Build (Debug)
        run: |
          $ErrorActionPreference = "Stop"
          $Target = "x86_64-pc-windows-msvc"

          Write-Host "Building mirrord-layer-win..."
          cargo build -p mirrord-layer-win --target $Target --debug

          $RelDir = Join-Path $env:GITHUB_WORKSPACE "target\$Target\debug"
          $dll = Join-Path $RelDir "mirrord_layer_win.dll"
          if (-not (Test-Path $dll)) { throw "mirrord_layer_win.dll not found" }

          # Set for the next build command in this session
          $env:MIRRORD_LAYER_FILE = $dll

          Write-Host "Building mirrord binary..."
          cargo build -p mirrord --bin mirrord --target $Target --debug
          
          $exe = Join-Path $RelDir "mirrord.exe"
          
          if (-not (Test-Path $exe)) { throw "mirrord.exe not found" }
          
          "MIRRORD_EXE=$exe" | Out-File -Append -FilePath $env:GITHUB_ENV
          "MIRRORD_LAYER_FILE=$dll" | Out-File -Append -FilePath $env:GITHUB_ENV

      - name: Run Windows E2E Tests
        run: |

          Write-Host "Running E2E tests..."
          # Note: skipping the specific test skipped in windows-build.yaml
          cargo test --target=x86_64-pc-windows-msvc -p mirrord-tests -- --nocapture
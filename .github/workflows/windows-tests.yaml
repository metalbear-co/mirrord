name: Windows E2E Tests

on:
  pull_request:
    types: [labeled]
  workflow_dispatch:

env:
  RUST_BACKTRACE: "1"
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"
  MIRRORD_TELEMETRY: "false"
  LIBCLANG_PATH: "C:\\Program Files\\LLVM\\bin"

jobs:
  windows_e2e:
    if: contains(github.event.pull_request.labels.*.name, 'windows-e2e')
    runs-on: win-build-spot-1
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Verify Kubeconfig (Existing)
        run: |
           $KubePath = "$env:USERPROFILE\.kube\config"
           Write-Host "Checking for existing Kubeconfig at: $KubePath"
           
           if (-not (Test-Path $KubePath)) {
               Write-Error "KUBECONFIG NOT FOUND on runner! This workflow relies on a pre-configured ~/.kube/config."
               exit 1
           }
           
           $Size = (Get-Item $KubePath).Length
           if ($Size -lt 10) {
               Write-Error "Kubeconfig is empty ($Size bytes)."
               exit 1
           }
           Write-Host "Kubeconfig found ($Size bytes). Using existing file."

      - name: Close existing tunnels (Port 6443)
        run: |
          $port = 6443
          # Kill gcloud IAP processes
          Get-Process -Name "gcloud" -ErrorAction SilentlyContinue | Stop-Process -Force
          # Kill anything else on 6443
          $connections = Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue
          if ($connections) {
              Write-Host "Killing processes listening on port $port..."
              foreach ($conn in $connections) {
                  Stop-Process -Id $conn.OwningProcess -Force -ErrorAction SilentlyContinue
              }
          }

      - name: Start IAP Tunnel to K3s
        run: |
          # Ensure kubectl is available for verification
          if (-not (Get-Command kubectl -ErrorAction SilentlyContinue)) {
              Write-Host "Installing kubectl..."
              choco install kubernetes-cli -y
          }

          Write-Host "Configuring gcloud..."
          # Switch to the Compute Engine Service Account to avoid interactive auth prompts
          gcloud config set account "174145836594-compute@developer.gserviceaccount.com"
          gcloud config set project "mirrord"
          gcloud config set core/disable_prompts true
          gcloud info
          gcloud auth list

          Write-Host "Starting IAP Tunnel..."
          $LogFile = "$env:TEMP\iap_tunnel.log"
          $ErrFile = "$env:TEMP\iap_tunnel.err"
          
          # Remove --quiet to capture debug output in logs
          $GcloudArgs = "compute start-iap-tunnel k3s-tests-1 6443 --local-host-port=127.0.0.1:6443 --zone=us-central1-a"
          
          # Start process efficiently with redirection (Wrapped in cmd /c because gcloud is a batch file on Windows)
          $Process = Start-Process -FilePath "cmd.exe" -ArgumentList "/c gcloud $GcloudArgs" -NoNewWindow -PassThru -RedirectStandardOutput $LogFile -RedirectStandardError $ErrFile
          
          # Wait for tunnel (10s timeout)
          for ($i=1; $i -le 5; $i++) {
              Start-Sleep -Seconds 2
              
              if ($Process.HasExited) {
                  Write-Error "Tunnel process exited prematurely (Exit Code: $($Process.ExitCode))"
                  break
              }

              if (Test-NetConnection -ComputerName "127.0.0.1" -Port 6443 -InformationLevel Quiet) {
                  Write-Host "Tunnel Established."
                  break
              }
              Write-Host "Waiting for tunnel... ($i/5)"
          }

          if (-not (Test-NetConnection -ComputerName "127.0.0.1" -Port 6443 -InformationLevel Quiet)) {
               Write-Error "Failed to establish IAP tunnel on port 6443."
               
               Write-Host "--- STDOUT ---"
               if (Test-Path $LogFile) { Get-Content $LogFile }
               Write-Host "--- STDERR ---"
               if (Test-Path $ErrFile) { Get-Content $ErrFile }
               Write-Host "--------------"
               
               if (-not $Process.HasExited) {
                   Stop-Process -Id $Process.Id -Force
               }
               exit 1
          }
          
          # Verify Kubernetes API Connectivity immediately
          Write-Host "Verifying Kubernetes API..."
          $env:KUBECONFIG = "$env:USERPROFILE\.kube\config"
          
          if (-not (Test-Path $env:KUBECONFIG)) {
              Write-Error "KUBECONFIG file not found at $env:KUBECONFIG"
              exit 1
          }
          
          $ConfigSize = (Get-Item $env:KUBECONFIG).Length
          Write-Host "Kubeconfig found. Size: $ConfigSize bytes."
          if ($ConfigSize -lt 10) {
              Write-Error "Kubeconfig is empty or too small!"
              Get-Content $env:KUBECONFIG
              exit 1
          }

          kubectl get pods -A
          if ($LASTEXITCODE -ne 0) {
             Write-Error "Failed to connect to Kubernetes API via tunnel. Exit Code: $LASTEXITCODE"
             exit 1
          }
          Write-Host "Kubernetes API Connection Successful."

      - name: Toolchain info
        run: |
          $ErrorActionPreference = "Stop"
          whoami
          rustc -V
          cargo -V
          rustup show

      - name: Prepare e2e tests dependencies
        run: |
          $ErrorActionPreference = "Stop"
          $ScriptsDir = Join-Path $env:GITHUB_WORKSPACE "scripts"
          & "$ScriptsDir\win_build_test_apps.ps1"

      - name: Ensure Python test deps (flask/uvicorn/fastapi)
        run: |
          $ErrorActionPreference = "Stop"
          $py = Get-Command py -ErrorAction SilentlyContinue
          if (-not $py) {
            throw "py launcher not found; ensure Python is installed."
          }
          py -3 -m pip install --upgrade pip
          py -3 -m pip install --upgrade flask uvicorn fastapi

      - name: Build (Release)
        run: |
          $ErrorActionPreference = "Stop"
          $Target = "x86_64-pc-windows-msvc"
          rustup target add $Target

          Write-Host "Building mirrord-layer-win..."
          cargo build -p mirrord-layer-win --target $Target --release

          Write-Host "Building mirrord binary..."
          cargo build -p mirrord --bin mirrord --target $Target --release
          
          # Set Env Vars for tests
          $RelDir = Join-Path $env:GITHUB_WORKSPACE "target\$Target\release"
          $exe = Join-Path $RelDir "mirrord.exe"
          $dll = Join-Path $RelDir "mirrord_layer_win.dll"
          
          if (-not (Test-Path $exe)) { throw "mirrord.exe not found" }
          if (-not (Test-Path $dll)) { throw "mirrord_layer_win.dll not found" }
          
          "MIRRORD_EXE=$exe" | Out-File -Append -FilePath $env:GITHUB_ENV
          "MIRRORD_LAYER_FILE=$dll" | Out-File -Append -FilePath $env:GITHUB_ENV

      - name: Run Windows E2E Tests
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "Running Integration/E2E tests..."
          # Note: skipping the specific test skipped in windows-build.yaml
          cargo test --target=x86_64-pc-windows-msvc -p mirrord -p mirrord-layer-win --release -- --nocapture --skip test::reconnect_during_http::drop_during_response_2_false
        env:
          KUBECONFIG: ${{ env.USERPROFILE }}\.kube\config

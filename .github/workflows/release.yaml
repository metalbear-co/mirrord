name: Release

env:
  NIGHTLY_TOOLCHAIN: nightly-2026-02-12

on:
  push:
    tags:
      - "*.*.*"
  # Running from workflow dispatch (AKA manual) will not publish anything.
  # This is intended for testing changes to this flow.
  workflow_dispatch:
    inputs:


jobs:
  build_binaries_aarch64-unknown-linux-gnu:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: metalbear-co/setup-rust-toolchain@009cda47e1b529982a00627a40eda87b4215035a
        with:
          rustflags: ""

      #      - uses: metalbear-co/install-action@62730e3d4f6bd81d824694e963e06d7153968c93
      #        with:
      #          tool: cross
      # We used to install the latest cross version (0.2.5) but it's too old (Feb 2023) and is missing essential bug fixes
      # When 0.3.0 (or 0.2.6, but it seems unlikely) is released, we should use that
      - name: Install cross from a recent commit
        run: cargo install --git https://github.com/cross-rs/cross cross --rev 154b4ead7e639c7597d9e4e626b9c1c1e37608c0
      - uses: actions/setup-node@v3
        with:
          node-version: 24
      - run: npm install
        working-directory: ./wizard-frontend
      - run: npm run build
        working-directory: ./wizard-frontend
      # building layer and cli together leads to weird situation where embedded layer is x64, so split.
      - name: build mirrord-layer
        run: RUSTFLAGS="$RUSTFLAGS -A dead_code" cross build --release -p mirrord-layer --target=aarch64-unknown-linux-gnu
      - name: build mirrord cli
        env:
          MIRRORD_LAYER_FILE: ../../../target/aarch64-unknown-linux-gnu/release/libmirrord_layer.so
          WIZARD_DIST_DIR: ./wizard-frontend/dist
        run: RUSTFLAGS="$RUSTFLAGS -A dead_code" cross build --release -p mirrord --target=aarch64-unknown-linux-gnu --features "wizard"
      - uses: actions/upload-artifact@v4
        with:
          name: aarch64-unknown-linux-gnu
          path: |
            target/aarch64-unknown-linux-gnu/release/mirrord
            target/aarch64-unknown-linux-gnu/release/libmirrord_layer.so
          if-no-files-found: error
  build_binaries_x86_64-unknown-linux-gnu:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: metalbear-co/setup-rust-toolchain@009cda47e1b529982a00627a40eda87b4215035a
        with:
          rustflags: ""
      #      - uses: metalbear-co/install-action@62730e3d4f6bd81d824694e963e06d7153968c93
      #        with:
      #          tool: cross
      # We used to install the latest cross version (0.2.5) but it's too old (Feb 2023) and is missing essential bug fixes
      # When 0.3.0 (or 0.2.6, but it seems unlikely) is released, we should use that
      - name: Install cross from a recent commit
        run: cargo install --git https://github.com/cross-rs/cross cross --rev 154b4ead7e639c7597d9e4e626b9c1c1e37608c0
      - uses: actions/setup-node@v3
        with:
          node-version: 24
      - run: npm install
        working-directory: ./wizard-frontend
      - run: npm run build
        working-directory: ./wizard-frontend
      - name: build mirrord-layer and cli
        env:
          WIZARD_DIST_DIR: ./wizard-frontend/dist
        run: cross build --release -p mirrord -p mirrord-layer --target=x86_64-unknown-linux-gnu --features "wizard"
      - uses: actions/upload-artifact@v4
        with:
          name: x86_64-unknown-linux-gnu
          path: |
            target/x86_64-unknown-linux-gnu/release/mirrord
            target/x86_64-unknown-linux-gnu/release/libmirrord_layer.so
          if-no-files-found: error
  build_binaries_windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: metalbear-co/setup-rust-toolchain@009cda47e1b529982a00627a40eda87b4215035a
        with:
          rustflags: ""

      - name: Install WiX Toolset
        run: |
          choco install wixtoolset -y
          $env:PATH = "C:\Program Files (x86)\WiX Toolset v3.14\bin;$env:PATH"
          echo "C:\Program Files (x86)\WiX Toolset v3.14\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Get release version
        id: version
        run: |
          $version = (Select-String -Path "Cargo.toml" -Pattern '^version\s*=\s*"([^"]+)"' | Select-Object -First 1).Matches.Groups[1].Value
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Build mirrord DLL and EXE
        run: |
          $ErrorActionPreference = "Stop"

          # Build DLL in release mode
          cargo build --release -p mirrord-layer-win --target x86_64-pc-windows-msvc
          $dll = "target\x86_64-pc-windows-msvc\release\mirrord_layer_win.dll"
          if (-not (Test-Path $dll)) {
            throw "DLL not found at $dll"
          }

          # Build EXE in release mode
          $env:MIRRORD_LAYER_FILE = (Resolve-Path $dll).Path
          cargo build --release -p mirrord --bin mirrord --target x86_64-pc-windows-msvc
          $exe = "target\x86_64-pc-windows-msvc\release\mirrord.exe"
          if (-not (Test-Path $exe)) {
            throw "EXE not found at $exe"
          }

          # Save paths for next steps
          echo "MIRRORD_DLL=$dll" >> $env:GITHUB_ENV
          echo "MIRRORD_EXE=$exe" >> $env:GITHUB_ENV
      - name: Setup SM_CLIENT_CERT_FILE from base64 secret data
        run: |
          $certPath = Join-Path $env:RUNNER_TEMP "sm_client_cert.p12"
          $certBytes = [System.Convert]::FromBase64String("${{ secrets.SM_CLIENT_CERT_FILE_B64 }}")
          [System.IO.File]::WriteAllBytes($certPath, $certBytes)
          echo "SM_CLIENT_CERT_FILE=$certPath" >> $env:GITHUB_ENV

      - name: Setup Software Trust Manager
        uses: digicert/code-signing-software-trust-action@v1.0.1
        env:
          SM_HOST: https://clientauth.one.digicert.com/
          SM_API_KEY: ${{ secrets.SM_API_KEY }}
          SM_CLIENT_CERT_PASSWORD: ${{ secrets.SM_CLIENT_CERT_PASSWORD }}

      - name: Sign DLL and EXE
        env:
          DIGICERT_KEYPAIR_ALIAS: ${{ secrets.SM_KEYPAIR_ALIAS }}
          SM_HOST: https://clientauth.one.digicert.com/
          SM_API_KEY: ${{ secrets.SM_API_KEY }}
          SM_CLIENT_CERT_PASSWORD: ${{ secrets.SM_CLIENT_CERT_PASSWORD }}
        run: |
          $ErrorActionPreference = "Stop"
          $Arch = ($env:RUNNER_ARCH).ToLower()
          $SearchBase = "${env:ProgramFiles(x86)}\Windows Kits\10\bin"

          "Searching `"$SearchBase`" for signtool ($Arch)..."
          $Tool = Get-ChildItem $SearchBase -Recurse -Force -ErrorAction SilentlyContinue |
              Where-Object {$_.Name -eq 'signtool.exe' -and $_.Directory -like "*\$Arch"} |
              Sort-Object -Descending |
              Select-Object -First 1

          if (!($Tool)) {throw [System.IO.FileNotFoundException]::new('File not found.', 'signtool.exe')}

          'Adding signtool to PATH'
          $Tool.Directory.FullName | Out-File $env:GITHUB_PATH -Append
          "signtool-$Arch=$($Tool.FullName)" | Out-File $env:GITHUB_OUTPUT -Append
          $env:PATH = "$($Tool.Directory.FullName);$env:PATH"

          echo "PATH=$PATH" >> $env:GITHUB_ENV

          # Sign using DigiCert smctl
          smctl sign --keypair-alias="$env:DIGICERT_KEYPAIR_ALIAS" `
            --input="$env:MIRRORD_DLL" `
            --verbose --exit-non-zero-on-fail

          smctl sign --keypair-alias="$env:DIGICERT_KEYPAIR_ALIAS" `
            --input="$env:MIRRORD_EXE" `
            --verbose --exit-non-zero-on-fail

      - name: Build MSI
        run: |
          $ErrorActionPreference = "Stop"

          # Create working directory
          $wixDir = "$env:RUNNER_TEMP\wix"
          New-Item -ItemType Directory -Force -Path $wixDir | Out-Null

          # Copy binary files
          Copy-Item $env:MIRRORD_EXE "$wixDir\mirrord.exe" -Force
          Copy-Item $env:MIRRORD_DLL "$wixDir\mirrord_layer_win.dll" -Force
          Copy-Item "mirrord\cli\wix\mirrord.ico" "$wixDir\mirrord.ico" -Force
          Copy-Item "mirrord\cli\wix\License.rtf" "$wixDir\License.rtf" -Force

          # Get version from step output
          $version = "${{ steps.version.outputs.version }}"


          # Read WXS file directly and write with updated version (avoid Copy-Item encoding issues)
          $wxsSource = "mirrord\cli\wix\main.wxs"
          $wxsPath = "$wixDir\main.wxs"
          $utf8NoBom = [System.Text.UTF8Encoding]::new($false)
          $wxsContent = [System.IO.File]::ReadAllText($wxsSource, $utf8NoBom)
          # Replace Product Version attribute (case-sensitive to avoid XML declaration)
          $wxsContent = $wxsContent -creplace '(<Product[^>]+Version=)"[^"]*"', "`$1`"$version`""
          [System.IO.File]::WriteAllText($wxsPath, $wxsContent, $utf8NoBom)

          Write-Host "Updated WXS Product Version to: $version"

          # Build MSI
          $obj = "$wixDir\main.wixobj"
          $msi = "$wixDir\mirrord.msi"

          candle.exe -nologo "$wixDir\main.wxs" -out $obj
          if ($LASTEXITCODE -ne 0) { throw "candle.exe failed" }

          light.exe -nologo $obj -out $msi -ext WixUIExtension -sval
          if ($LASTEXITCODE -ne 0) { throw "light.exe failed" }

          if (-not (Test-Path $msi)) {
            throw "MSI not produced"
          }

          echo "MIRRORD_MSI=$msi" >> $env:GITHUB_ENV

      - name: Sign MSI
        env:
          DIGICERT_KEYPAIR_ALIAS: ${{ secrets.SM_KEYPAIR_ALIAS }}
          SM_HOST: https://clientauth.one.digicert.com/
          SM_API_KEY: ${{ secrets.SM_API_KEY }}
          SM_CLIENT_CERT_PASSWORD: ${{ secrets.SM_CLIENT_CERT_PASSWORD }}
        run: |
          $ErrorActionPreference = "Stop"

          $Arch = ($env:RUNNER_ARCH).ToLower()
          $SearchBase = "${env:ProgramFiles(x86)}\Windows Kits\10\bin"

          "Searching `"$SearchBase`" for signtool ($Arch)..."
          $Tool = Get-ChildItem $SearchBase -Recurse -Force -ErrorAction SilentlyContinue |
              Where-Object {$_.Name -eq 'signtool.exe' -and $_.Directory -like "*\$Arch"} |
              Sort-Object -Descending |
              Select-Object -First 1

          if (!($Tool)) {throw [System.IO.FileNotFoundException]::new('File not found.', 'signtool.exe')}

          'Adding signtool to PATH'
          $Tool.Directory.FullName | Out-File $env:GITHUB_PATH -Append
          "signtool-$Arch=$($Tool.FullName)" | Out-File $env:GITHUB_OUTPUT -Append
          $env:PATH = "$($Tool.Directory.FullName);$env:PATH"

          smctl sign --keypair-alias="$env:DIGICERT_KEYPAIR_ALIAS" `
            --input="$env:MIRRORD_MSI" `
            --exit-non-zero-on-fail --verbose

      - name: Generate checksums
        run: |
          $exe = $env:MIRRORD_EXE
          $dll = $env:MIRRORD_DLL
          $msi = $env:MIRRORD_MSI

          (Get-FileHash $exe -Algorithm SHA256).Hash.ToLower() | Out-File -FilePath "$exe.sha256" -NoNewline -Encoding ascii
          (Get-FileHash $dll -Algorithm SHA256).Hash.ToLower() | Out-File -FilePath "$dll.sha256" -NoNewline -Encoding ascii
          (Get-FileHash $msi -Algorithm SHA256).Hash.ToLower() | Out-File -FilePath "$msi.sha256" -NoNewline -Encoding ascii

      - uses: actions/upload-artifact@v4
        with:
          name: x86_64-pc-windows-msvc
          path: |
            ${{ env.MIRRORD_EXE }}
            ${{ env.MIRRORD_DLL }}
            ${{ env.MIRRORD_MSI }}
            ${{ env.MIRRORD_EXE }}.sha256
            ${{ env.MIRRORD_DLL }}.sha256
            ${{ env.MIRRORD_MSI }}.sha256
          if-no-files-found: error

  # Stage 1: Build x86_64 layer (runs in parallel)
  build_layer_macos_x86_64:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
      - run: rm rust-toolchain.toml
      - uses: metalbear-co/setup-rust-toolchain@009cda47e1b529982a00627a40eda87b4215035a
        with:
          target: x86_64-apple-darwin
          toolchain: ${{ env.NIGHTLY_TOOLCHAIN }}
          rustflags: ""
          cache: false
      - name: Import Code-Signing Certificates
        uses: metalbear-co/import-codesign-certs@7f43a75d5120d645e67d471d678ccbff1d140cd6
        with:
          p12-file-base64: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 }}
          p12-password: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
      - name: Install gon via HomeBrew for code signing and app notarization
        run: |
          brew tap mitchellh/gon
          brew install mitchellh/gon/gon
      - name: Build x86_64 layer
        env:
          AC_USERNAME: ${{ secrets.APPLE_DEVELOPER }}
          AC_PASSWORD: ${{ secrets.APPLE_DEVELOPER_PASSWORD }}
        run: cargo +${{ env.NIGHTLY_TOOLCHAIN }} xtask build-layer --platform macos-x86_64 --release
      - uses: actions/upload-artifact@v4
        with:
          name: layer-x86_64-apple-darwin
          path: target/x86_64-apple-darwin/release/libmirrord_layer.dylib
          if-no-files-found: error

  # Stage 1: Build aarch64 layer + shim (runs in parallel)
  build_layer_macos_aarch64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - run: rm rust-toolchain.toml
      - uses: metalbear-co/setup-rust-toolchain@009cda47e1b529982a00627a40eda87b4215035a
        with:
          target: aarch64-apple-darwin
          toolchain: ${{ env.NIGHTLY_TOOLCHAIN }}
          rustflags: ""
          cache: false
      - name: Import Code-Signing Certificates
        uses: metalbear-co/import-codesign-certs@7f43a75d5120d645e67d471d678ccbff1d140cd6
        with:
          p12-file-base64: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 }}
          p12-password: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
      - name: Install gon via HomeBrew for code signing and app notarization
        run: |
          brew tap mitchellh/gon
          brew install mitchellh/gon/gon
      - name: Build aarch64 layer + shim
        env:
          AC_USERNAME: ${{ secrets.APPLE_DEVELOPER }}
          AC_PASSWORD: ${{ secrets.APPLE_DEVELOPER_PASSWORD }}
        run: cargo +${{ env.NIGHTLY_TOOLCHAIN }} xtask build-layer --platform macos-aarch64 --release
      - uses: actions/upload-artifact@v4
        with:
          name: layer-aarch64-apple-darwin
          path: |
            target/aarch64-apple-darwin/release/libmirrord_layer.dylib
            target/aarch64-apple-darwin/release/shim.dylib
          if-no-files-found: error

  # Stage 2: Link universal layer from pre-built layers
  link_layer_macos_universal:
    runs-on: macos-15
    needs: [build_layer_macos_x86_64, build_layer_macos_aarch64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: layer-x86_64-apple-darwin
          path: artifacts/layer-x86_64
      - uses: actions/download-artifact@v4
        with:
          name: layer-aarch64-apple-darwin
          path: artifacts/layer-aarch64
      - name: Recreate cargo target structure
        run: |
          mkdir -p target/x86_64-apple-darwin/release
          mkdir -p target/aarch64-apple-darwin/release
          cp artifacts/layer-x86_64/libmirrord_layer.dylib target/x86_64-apple-darwin/release/
          cp artifacts/layer-aarch64/libmirrord_layer.dylib target/aarch64-apple-darwin/release/
          cp artifacts/layer-aarch64/shim.dylib target/aarch64-apple-darwin/release/
      - name: Import Code-Signing Certificates
        uses: metalbear-co/import-codesign-certs@7f43a75d5120d645e67d471d678ccbff1d140cd6
        with:
          p12-file-base64: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 }}
          p12-password: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
      - name: Install gon via HomeBrew for code signing and app notarization
        run: |
          brew tap mitchellh/gon
          brew install mitchellh/gon/gon
      - name: Link universal layer
        env:
          AC_USERNAME: ${{ secrets.APPLE_DEVELOPER }}
          AC_PASSWORD: ${{ secrets.APPLE_DEVELOPER_PASSWORD }}
        run: cargo xtask link-layer-universal --release
      - uses: actions/upload-artifact@v4
        with:
          name: layer-universal-apple-darwin
          path: |
            target/universal-apple-darwin/release/libmirrord_layer.dylib
            target/aarch64-apple-darwin/release/libmirrord_layer.dylib
          if-no-files-found: error

  # Stage 3: Build x86_64 CLI (runs in parallel)
  build_cli_macos_x86_64:
    runs-on: macos-15-intel
    needs: [link_layer_macos_universal]
    steps:
      - uses: actions/checkout@v4
      - run: rm rust-toolchain.toml
      - uses: metalbear-co/setup-rust-toolchain@009cda47e1b529982a00627a40eda87b4215035a
        with:
          target: x86_64-apple-darwin
          toolchain: ${{ env.NIGHTLY_TOOLCHAIN }}
          rustflags: ""
          cache: false
      - uses: actions/setup-node@v3
        with:
          node-version: 24
      - uses: actions/download-artifact@v4
        with:
          name: layer-universal-apple-darwin
          path: artifacts/layer-universal
      - name: Recreate layer structure
        run: |
          mkdir -p target/universal-apple-darwin/release
          mkdir -p target/aarch64-apple-darwin/release
          cp artifacts/layer-universal/universal-apple-darwin/release/libmirrord_layer.dylib target/universal-apple-darwin/release/
          cp artifacts/layer-universal/aarch64-apple-darwin/release/libmirrord_layer.dylib target/aarch64-apple-darwin/release/
      - name: Import Code-Signing Certificates
        uses: metalbear-co/import-codesign-certs@7f43a75d5120d645e67d471d678ccbff1d140cd6
        with:
          p12-file-base64: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 }}
          p12-password: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
      - name: Install gon via HomeBrew for code signing and app notarization
        run: |
          brew tap mitchellh/gon
          brew install mitchellh/gon/gon
      - name: Build x86_64 CLI
        env:
          MIRRORD_LAYER_FILE: ${{ github.workspace }}/target/universal-apple-darwin/release/libmirrord_layer.dylib
          MIRRORD_LAYER_FILE_MACOS_ARM64: ${{ github.workspace }}/target/aarch64-apple-darwin/release/libmirrord_layer.dylib
          AC_USERNAME: ${{ secrets.APPLE_DEVELOPER }}
          AC_PASSWORD: ${{ secrets.APPLE_DEVELOPER_PASSWORD }}
        run: cargo +${{ env.NIGHTLY_TOOLCHAIN }} xtask build-cli --platform macos-x86_64 --release
      - uses: actions/upload-artifact@v4
        with:
          name: cli-x86_64-apple-darwin
          path: target/x86_64-apple-darwin/release/mirrord
          if-no-files-found: error

  # Stage 3: Build aarch64 CLI (runs in parallel)
  build_cli_macos_aarch64:
    runs-on: macos-15
    needs: [link_layer_macos_universal]
    steps:
      - uses: actions/checkout@v4
      - run: rm rust-toolchain.toml
      - uses: metalbear-co/setup-rust-toolchain@009cda47e1b529982a00627a40eda87b4215035a
        with:
          target: aarch64-apple-darwin
          toolchain: ${{ env.NIGHTLY_TOOLCHAIN }}
          rustflags: ""
          cache: false
      - uses: actions/setup-node@v3
        with:
          node-version: 24
      - uses: actions/download-artifact@v4
        with:
          name: layer-universal-apple-darwin
          path: artifacts/layer-universal
      - name: Recreate layer structure
        run: |
          mkdir -p target/universal-apple-darwin/release
          mkdir -p target/aarch64-apple-darwin/release
          cp artifacts/layer-universal/universal-apple-darwin/release/libmirrord_layer.dylib target/universal-apple-darwin/release/
          cp artifacts/layer-universal/aarch64-apple-darwin/release/libmirrord_layer.dylib target/aarch64-apple-darwin/release/
      - name: Import Code-Signing Certificates
        uses: metalbear-co/import-codesign-certs@7f43a75d5120d645e67d471d678ccbff1d140cd6
        with:
          p12-file-base64: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 }}
          p12-password: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
      - name: Install gon via HomeBrew for code signing and app notarization
        run: |
          brew tap mitchellh/gon
          brew install mitchellh/gon/gon
      - name: Build aarch64 CLI
        env:
          MIRRORD_LAYER_FILE: ${{ github.workspace }}/target/universal-apple-darwin/release/libmirrord_layer.dylib
          MIRRORD_LAYER_FILE_MACOS_ARM64: ${{ github.workspace }}/target/aarch64-apple-darwin/release/libmirrord_layer.dylib
          AC_USERNAME: ${{ secrets.APPLE_DEVELOPER }}
          AC_PASSWORD: ${{ secrets.APPLE_DEVELOPER_PASSWORD }}
        run: cargo +${{ env.NIGHTLY_TOOLCHAIN }} xtask build-cli --platform macos-aarch64 --release
      - uses: actions/upload-artifact@v4
        with:
          name: cli-aarch64-apple-darwin
          path: target/aarch64-apple-darwin/release/mirrord
          if-no-files-found: error

  # Stage 4: Merge universal CLI from pre-built CLIs
  merge_cli_macos_universal:
    runs-on: macos-15
    needs: [build_cli_macos_x86_64, build_cli_macos_aarch64, link_layer_macos_universal]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: cli-x86_64-apple-darwin
          path: artifacts/cli-x86_64
      - uses: actions/download-artifact@v4
        with:
          name: cli-aarch64-apple-darwin
          path: artifacts/cli-aarch64
      - uses: actions/download-artifact@v4
        with:
          name: layer-universal-apple-darwin
          path: artifacts/layer-universal
      - name: Recreate cargo target structure
        run: |
          mkdir -p target/x86_64-apple-darwin/release
          mkdir -p target/aarch64-apple-darwin/release
          mkdir -p target/universal-apple-darwin/release
          cp artifacts/cli-x86_64/mirrord target/x86_64-apple-darwin/release/
          cp artifacts/cli-aarch64/mirrord target/aarch64-apple-darwin/release/
          cp artifacts/layer-universal/universal-apple-darwin/release/libmirrord_layer.dylib target/universal-apple-darwin/release/
      - name: Import Code-Signing Certificates
        uses: metalbear-co/import-codesign-certs@7f43a75d5120d645e67d471d678ccbff1d140cd6
        with:
          p12-file-base64: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 }}
          p12-password: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
      - name: Install gon via HomeBrew for code signing and app notarization
        run: |
          brew tap mitchellh/gon
          brew install mitchellh/gon/gon
      - name: Merge universal CLI
        env:
          AC_USERNAME: ${{ secrets.APPLE_DEVELOPER }}
          AC_PASSWORD: ${{ secrets.APPLE_DEVELOPER_PASSWORD }}
        run: cargo xtask merge-cli-universal --release
      - uses: actions/upload-artifact@v4
        with:
          name: universal-apple-darwin
          path: |
            target/universal-apple-darwin/release/mirrord
            target/universal-apple-darwin/release/libmirrord_layer.dylib
          if-no-files-found: error

  release_docker_image:
    runs-on: ubuntu-24.04
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Check disk space
        run: df . -h
      - name: Free disk space
        continue-on-error: true
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo docker rmi $(docker image ls -aq) >/dev/null 2>&1 || true
          sudo rm -rf \
            /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /usr/local/share/powershell /usr/share/swift /usr/local/.ghcup \
            /usr/lib/jvm || true
          echo "some directories deleted"
          sudo apt install aptitude -y >/dev/null 2>&1
          sudo aptitude purge aria2 ansible azure-cli shellcheck rpm xorriso zsync \
            esl-erlang firefox gfortran-8 gfortran-9 google-chrome-stable \
            google-cloud-sdk imagemagick \
            libmagickcore-dev libmagickwand-dev libmagic-dev ant ant-optional kubectl \
            mercurial apt-transport-https mono-complete libmysqlclient \
            unixodbc-dev yarn chrpath libssl-dev libxft-dev \
            libfreetype6 libfreetype6-dev libfontconfig1 libfontconfig1-dev \
            snmp pollinate libpq-dev postgresql-client powershell ruby-full \
            sphinxsearch subversion mongodb-org azure-cli microsoft-edge-stable \
            -y -f >/dev/null 2>&1
          sudo aptitude purge google-cloud-sdk -f -y >/dev/null 2>&1
          sudo aptitude purge microsoft-edge-stable -f -y >/dev/null 2>&1 || true
          sudo apt purge microsoft-edge-stable -f -y >/dev/null 2>&1 || true
          sudo aptitude purge '~n ^mysql' -f -y >/dev/null 2>&1
          sudo aptitude purge '~n ^php' -f -y >/dev/null 2>&1
          sudo aptitude purge '~n ^dotnet' -f -y >/dev/null 2>&1
          sudo apt-get autoremove -y >/dev/null 2>&1
          sudo apt-get autoclean -y >/dev/null 2>&1
          echo "some packages purged"
      - name: Check disk space
        run: |
          sudo dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -nr | head
          df . -h
          sudo du /usr/ -hx -d 4 --threshold=1G | sort -hr | head
      - name: Set up QEMU
        id: qemu
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Get release version
        run: |
          echo "version=$(grep -m 1 version Cargo.toml | cut -d' ' -f3 | tr -d '\"')" >> $GITHUB_OUTPUT
        id: version

      - name: Build and push (test)
        if: github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          context: .
          file: mirrord/agent/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/metalbear-co/mirrord-staging:${{ github.sha }}

      - name: Build and push (final/release)
        if: github.event_name != 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          context: .
          file: mirrord/agent/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/metalbear-co/mirrord:latest
            ghcr.io/metalbear-co/mirrord:${{ steps.version.outputs.version }}

  release_cli_docker_image:
    runs-on: ubuntu-24.04
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Check disk space
        run: df . -h
      - name: Free disk space
        continue-on-error: true
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo docker rmi $(docker image ls -aq) >/dev/null 2>&1 || true
          sudo rm -rf \
            /usr/share/dotnet /usr/local/lib/android /opt/ghc \
            /usr/local/share/powershell /usr/share/swift /usr/local/.ghcup \
            /usr/lib/jvm || true
          echo "some directories deleted"
          sudo apt install aptitude -y >/dev/null 2>&1
          sudo aptitude purge aria2 ansible azure-cli shellcheck rpm xorriso zsync \
            esl-erlang firefox gfortran-8 gfortran-9 google-chrome-stable \
            google-cloud-sdk imagemagick \
            libmagickcore-dev libmagickwand-dev libmagic-dev ant ant-optional kubectl \
            mercurial apt-transport-https mono-complete libmysqlclient \
            unixodbc-dev yarn chrpath libssl-dev libxft-dev \
            libfreetype6 libfreetype6-dev libfontconfig1 libfontconfig1-dev \
            snmp pollinate libpq-dev postgresql-client powershell ruby-full \
            sphinxsearch subversion mongodb-org azure-cli microsoft-edge-stable \
            -y -f >/dev/null 2>&1
          sudo aptitude purge google-cloud-sdk -f -y >/dev/null 2>&1
          sudo aptitude purge microsoft-edge-stable -f -y >/dev/null 2>&1 || true
          sudo apt purge microsoft-edge-stable -f -y >/dev/null 2>&1 || true
          sudo aptitude purge '~n ^mysql' -f -y >/dev/null 2>&1
          sudo aptitude purge '~n ^php' -f -y >/dev/null 2>&1
          sudo aptitude purge '~n ^dotnet' -f -y >/dev/null 2>&1
          sudo apt-get autoremove -y >/dev/null 2>&1
          sudo apt-get autoclean -y >/dev/null 2>&1
          echo "some packages purged"
      - name: Check disk space
        run: |
          sudo dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -nr | head
          df . -h
          sudo du /usr/ -hx -d 4 --threshold=1G | sort -hr | head
      - name: Set up QEMU
        id: qemu
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Get release version
        run: |
          echo "version=$(grep -m 1 version Cargo.toml | cut -d' ' -f3 | tr -d '\"')" >> $GITHUB_OUTPUT
        id: version

      - name: Build and push (test)
        if: github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          context: .
          file: mirrord/cli/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/metalbear-co/mirrord-cli-staging:${{ github.sha }}

      - name: Build and push (final/release)
        if: github.event_name != 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          cache-from: type=gha
          cache-to: type=gha,mode=max
          context: .
          file: mirrord/cli/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/metalbear-co/mirrord-cli:${{ steps.version.outputs.version }}
            ghcr.io/metalbear-co/mirrord-cli:latest

  release_gh:
    needs:
      [
        build_binaries_aarch64-unknown-linux-gnu,
        build_binaries_x86_64-unknown-linux-gnu,
        build_binaries_windows,
        merge_cli_macos_universal,
        release_docker_image,
        release_cli_docker_image,
      ]
    runs-on: ubuntu-24.04
    if: github.event_name != 'workflow_dispatch'
    permissions:
      packages: write
      contents: write
      deployments: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: /tmp/artifacts
          pattern: +(*-unknown-linux-gnu|*-apple-darwin|*-pc-windows-msvc)
      - uses: metalbear-co/action-zip@0852c26906e00f8a315c704958823928d8018b28
      - name: Create mirrord linux-x64 zip file
        run: |
          zip mirrord_linux_x86_64.zip mirrord
          shasum -a 256 mirrord_linux_x86_64.zip > mirrord_linux_x86_64.shasum256
        working-directory: /tmp/artifacts/x86_64-unknown-linux-gnu
      - name: Create mirrord linux-aarch64 zip file
        run: |
          zip mirrord_linux_aarch64.zip mirrord
          shasum -a 256 mirrord_linux_aarch64.zip > mirrord_linux_aarch64.shasum256
        working-directory: /tmp/artifacts/aarch64-unknown-linux-gnu
      - name: Create mirrord macos zip file
        run: |
          zip mirrord_mac_universal.zip mirrord
          shasum -a 256 mirrord_mac_universal.zip > mirrord_mac_universal.shasum256
        working-directory: /tmp/artifacts/universal-apple-darwin
      # used for the homebrew formula
      - uses: actions/upload-artifact@v4
        with:
          name: shasum
          path: |
            /tmp/artifacts/x86_64-unknown-linux-gnu/mirrord_linux_x86_64.shasum256
            /tmp/artifacts/aarch64-unknown-linux-gnu/mirrord_linux_aarch64.shasum256
            /tmp/artifacts/universal-apple-darwin/mirrord_mac_universal.shasum256
          if-no-files-found: error
      - name: Prepare binaries for upload
        run: |
          mkdir /tmp/release
          mv /tmp/artifacts/x86_64-unknown-linux-gnu/libmirrord_layer.so /tmp/release/libmirrord_layer_linux_x86_64.so
          mv /tmp/artifacts/x86_64-unknown-linux-gnu/mirrord /tmp/release/mirrord_linux_x86_64
          mv /tmp/artifacts/x86_64-unknown-linux-gnu/mirrord_linux_x86_64.zip /tmp/release/mirrord_linux_x86_64.zip
          mv /tmp/artifacts/x86_64-unknown-linux-gnu/mirrord_linux_x86_64.shasum256 /tmp/release/mirrord_linux_x86_64.shasum256

          mv /tmp/artifacts/aarch64-unknown-linux-gnu/libmirrord_layer.so /tmp/release/libmirrord_layer_linux_aarch64.so
          mv /tmp/artifacts/aarch64-unknown-linux-gnu/mirrord /tmp/release/mirrord_linux_aarch64
          mv /tmp/artifacts/aarch64-unknown-linux-gnu/mirrord_linux_aarch64.zip /tmp/release/mirrord_linux_aarch64.zip
          mv /tmp/artifacts/aarch64-unknown-linux-gnu/mirrord_linux_aarch64.shasum256 /tmp/release/mirrord_linux_aarch64.shasum256

          mv /tmp/artifacts/universal-apple-darwin/libmirrord_layer.dylib /tmp/release/libmirrord_layer_mac_universal.dylib
          mv /tmp/artifacts/universal-apple-darwin/mirrord /tmp/release/mirrord_mac_universal
          mv /tmp/artifacts/universal-apple-darwin/mirrord_mac_universal.zip /tmp/release/mirrord_mac_universal.zip
          mv /tmp/artifacts/universal-apple-darwin/mirrord_mac_universal.shasum256 /tmp/release/mirrord_mac_universal.shasum256

          mv /tmp/artifacts/x86_64-pc-windows-msvc/mirrord/mirrord/target/x86_64-pc-windows-msvc/release/mirrord.exe /tmp/release/mirrord.exe
          mv /tmp/artifacts/x86_64-pc-windows-msvc/mirrord/mirrord/target/x86_64-pc-windows-msvc/release/mirrord_layer_win.dll /tmp/release/mirrord_layer_win.dll
          mv /tmp/artifacts/x86_64-pc-windows-msvc/_temp/wix/mirrord.msi /tmp/release/mirrord.msi
          mv /tmp/artifacts/x86_64-pc-windows-msvc/mirrord/mirrord/target/x86_64-pc-windows-msvc/release/mirrord.exe.sha256 /tmp/release/mirrord.exe.sha256
          mv /tmp/artifacts/x86_64-pc-windows-msvc/mirrord/mirrord/target/x86_64-pc-windows-msvc/release/mirrord_layer_win.dll.sha256 /tmp/release/mirrord_layer_win.dll.sha256
          mv /tmp/artifacts/x86_64-pc-windows-msvc/_temp/wix/mirrord.msi.sha256 /tmp/release/mirrord.msi.sha256

      # Consider to add changelog generation..
      - name: Release
        uses: metalbear-co/action-gh-release@ab50eebb6488051c6788d97fa95232267c6a4e23
        with:
          files: /tmp/release/**

  release_homebrew:
    needs: release_gh
    runs-on: ubuntu-24.04
    if: github.event_name != 'workflow_dispatch'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: shasum
          path: /tmp/artifacts
      - uses: actions/checkout@v4
      - name: Get release version and hashes
        shell: bash # for -o pipefail, see https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions#exit-codes-and-error-action-preference
        run: |
          echo "version=$(grep -m 1 version Cargo.toml | cut -d' ' -f3 | tr -d '\"' | cut -d'-' -f1)" >> $GITHUB_ENV
          echo "sha256_mac=$(cat /tmp/artifacts/universal-apple-darwin/mirrord_mac_universal.shasum256 | awk '{ print $1 }')" >> $GITHUB_ENV
          echo "sha256_linux_aarch64=$(cat /tmp/artifacts/aarch64-unknown-linux-gnu/mirrord_linux_aarch64.shasum256 | awk '{ print $1 }')" >> $GITHUB_ENV
          echo "sha256_linux_x86_64=$(cat /tmp/artifacts/x86_64-unknown-linux-gnu/mirrord_linux_x86_64.shasum256 | awk '{ print $1 }')" >> $GITHUB_ENV
      - name: Checkout into homebrew-mirrord
        uses: actions/checkout@v4
        with:
          repository: metalbear-co/homebrew-mirrord
          path: ./
          token: ${{ secrets.BREW_GITHUB_PAT }}
      - name: Update hashes and urls
        run: |
          sed -i -e 's/\([0-9]\+\.[0-9]\+\.[0-9]\+\)/${{ env.version }}/g' mirrord.rb
          sed -z -i -e 's/[0-9a-f]\{64\}/${{ env.sha256_mac }}/1' mirrord.rb
          sed -z -i -e 's/[0-9a-f]\{64\}/${{ env.sha256_linux_aarch64 }}/2' mirrord.rb
          sed -z -i -e 's/[0-9a-f]\{64\}/${{ env.sha256_linux_x86_64 }}/3' mirrord.rb
      - name: Display formula (For debugging purposes only)
        run: cat mirrord.rb
      - name: Commit to metalbear-co/homebrew-mirrord
        run: |
          git config --global user.email "eyal@metalbear.co"
          git config --global user.name "Eyal Bukchin"
          git add .
          git commit -m "Update to ${{ env.version }}"
          git push

  release_chocolatey:
    needs: release_gh
    runs-on: windows-latest
    if: github.event_name != 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: x86_64-pc-windows-msvc
          path: artifacts/windows

      - name: Get release version
        id: version
        run: |
          $version = (Select-String -Path "Cargo.toml" -Pattern '^version\s*=\s*"([^"]+)"' | Select-Object -First 1).Matches.Groups[1].Value
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Build and publish Chocolatey package
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          $ErrorActionPreference = "Stop"

          # Get version from step output
          $version = "${{ steps.version.outputs.version }}"

          # Find the MSI file
          $msi = Get-ChildItem "artifacts/windows" -Filter "mirrord.msi" -Recurse | Select-Object -First 1
          if (-not $msi) {
            throw "MSI file not found in artifacts"
          }

          # Create Chocolatey package structure
          $pkgRoot = Join-Path $env:RUNNER_TEMP "choco"
          $toolsDir = Join-Path $pkgRoot "tools"
          New-Item -ItemType Directory -Force -Path $toolsDir | Out-Null

          # Copy MSI
          Copy-Item $msi.FullName (Join-Path $toolsDir "mirrord.msi") -Force

          # Copy LICENSE
          Copy-Item "LICENSE" (Join-Path $toolsDir "LICENSE.txt") -Force

          # Create VERIFICATION.txt
          $hash = Get-FileHash $msi.FullName -Algorithm SHA256
          @"
          VERIFICATION
          ------------

          1. Download the mirrord MSI from the official source:
             https://github.com/metalbear-co/mirrord/releases

          2. Verify the SHA256 checksum of the downloaded file matches:
             $($hash.Hash)

          This installer is built from the source at:
             https://github.com/metalbear-co/mirrord
          "@ | Set-Content -Encoding UTF8 -Path (Join-Path $toolsDir "VERIFICATION.txt")

          # Create nuspec file
          @"
          <?xml version="1.0"?>
          <package xmlns="http://schemas.microsoft.com/packaging/2015/06/nuspec.xsd">
            <metadata>
              <id>mirrord</id>
              <version>$version</version>
              <title>mirrord (Kubernetes dev tool)</title>
              <summary>Run local code in the context of your Kubernetes environment.</summary>
              <authors>MetalBear</authors>
              <owners>MetalBear</owners>
              <licenseUrl>https://github.com/metalbear-co/mirrord/blob/main/LICENSE</licenseUrl>
              <projectUrl>https://github.com/metalbear-co/mirrord</projectUrl>
              <packageSourceUrl>https://github.com/metalbear-co/mirrord</packageSourceUrl>
              <projectSourceUrl>https://github.com/metalbear-co/mirrord</projectSourceUrl>
              <docsUrl>https://mirrord.dev</docsUrl>
              <bugTrackerUrl>https://github.com/metalbear-co/mirrord/issues</bugTrackerUrl>
              <iconUrl>https://raw.githubusercontent.com/metalbear-co/mirrord/main/assets/icon.png</iconUrl>
              <requireLicenseAcceptance>false</requireLicenseAcceptance>
              <description>mirrord lets you run local code in the context of your cloud environment (Kubernetes).</description>
              <releaseNotes>https://github.com/metalbear-co/mirrord/releases/tag/$version</releaseNotes>
              <tags>mirrord kubernetes debugging cloud</tags>
            </metadata>
            <files>
              <file src="tools\**" target="tools" />
            </files>
          </package>
          "@ | Set-Content -Encoding UTF8 -Path (Join-Path $pkgRoot "mirrord.nuspec")

          # Create chocolateyinstall.ps1
          @'
          $ErrorActionPreference = 'Stop'

          $packageName = 'mirrord'
          $toolsDir    = Split-Path -Parent $MyInvocation.MyCommand.Definition
          $msiPath     = Join-Path $toolsDir 'mirrord.msi'

          Install-ChocolateyInstallPackage -PackageName $packageName -FileType 'msi' -SilentArgs '/qn /norestart' -ValidExitCodes @(0, 3010) -File $msiPath
          '@ | Set-Content -Encoding UTF8 -Path (Join-Path $toolsDir "chocolateyinstall.ps1")

          # Build package
          choco pack (Join-Path $pkgRoot "mirrord.nuspec") --outputdirectory $pkgRoot

          # Find the generated nupkg
          $nupkg = Get-ChildItem $pkgRoot -Filter "mirrord.$version.nupkg" -File | Select-Object -First 1
          if (-not $nupkg) {
            $nupkg = Get-ChildItem $pkgRoot -Filter "mirrord*.nupkg" -File | Select-Object -First 1
          }
          if (-not $nupkg) {
            throw "Failed to find generated nupkg in $pkgRoot"
          }

          Write-Host "Built Chocolatey package: $($nupkg.FullName)"

          # Publish to Chocolatey
          if (-not $env:CHOCO_API_KEY) {
            throw "CHOCO_API_KEY secret is not set. Cannot publish to Chocolatey."
          }

          Write-Host "Publishing to Chocolatey..."
          choco push $nupkg.FullName --api-key $env:CHOCO_API_KEY --source "https://push.chocolatey.org/"
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to publish to Chocolatey (exit code: $LASTEXITCODE)"
          }
          Write-Host "Successfully published to Chocolatey"

  release_winget:
    needs: release_gh
    runs-on: windows-latest
    if: github.event_name != 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Install .NET runtime for wingetcreate
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Get release version
        id: version
        run: |
          $version = (Select-String -Path "Cargo.toml" -Pattern '^version\s*=\s*"([^"]+)"' | Select-Object -First 1).Matches.Groups[1].Value
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Update WinGet manifest
        env:
          WINGET_TOKEN: ${{ secrets.WINGET_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"

          # Get version from step output
          $version = "${{ steps.version.outputs.version }}"

          # Construct MSI download URL from GitHub release
          $installerUrl = "https://github.com/metalbear-co/mirrord/releases/download/$version/mirrord.msi"
          $packageId = "MetalBear.mirrord"

          Write-Host "Updating WinGet manifest for package '$packageId' version '$version'"
          Write-Host "Installer URL: $installerUrl"

          # Validate WINGET_TOKEN is set
          if (-not $env:WINGET_TOKEN) {
            throw "WINGET_TOKEN secret is not set. Cannot publish to WinGet."
          }

          # Download wingetcreate
          Invoke-WebRequest https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

          # Update manifest
          $output = & .\wingetcreate.exe update $packageId `
            --version $version `
            --urls $installerUrl `
            --submit `
            --token $env:WINGET_TOKEN 2>&1

          $exitCode = $LASTEXITCODE

          # Display output
          $output | ForEach-Object { Write-Host $_ }

          # Check for errors
          if ($exitCode -ne 0) {
            if ($output -match "was not found") {
              throw "WinGet package '$packageId' was not found in microsoft/winget-pkgs. Create the initial package manually first."
            } else {
              throw "wingetcreate update failed with exit code $exitCode"
            }
          }

          Write-Host "Successfully updated WinGet manifest"

  update_latest:
    needs: release_homebrew
    runs-on: ubuntu-24.04
    if: github.event_name != 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          # Get complete history
          fetch-depth: 0

      - name: Update major version and latest tags in git
        uses: metalbear-co/release-tracker-action@main
        env:
          # GitHub token to enable pushing tags
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Move "latest" tag
          update-latest: true
          # Don't update the vX.Y tags
          update-minor: false

      - name: Update latest release on GitHub (not latest git tag).
        run: gh release edit "${{ github.ref_name }}" --latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

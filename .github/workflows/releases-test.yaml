name: Release Monitor

on:
  schedule:
    # Every 5 minutes (for testing)
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

permissions:
  contents: read
  packages: read

jobs:
  # ============================================================
  # 1) Check latest GitHub Release has all required assets
  # ============================================================
  check_latest_release:
    runs-on: ubuntu-24.04
    outputs:
      tag: ${{ steps.check.outputs.tag }}
      html_url: ${{ steps.check.outputs.html_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check latest GitHub Release assets
        id: check
        uses: actions/github-script@v7
        env:
          CHECK_TYPE: mirrord
        with:
          script: |
            const script = require('./.github/workflows/scripts/check_release.js');
            await script({ github, context, core, exec });

      - name: Notify Slack on REQUIRED asset failure
        if: steps.check.outputs.ok != 'true'
        shell: bash
        env:
          SLACK_PROD_ALERTS_WEBHOOK_URL: ${{ secrets.SLACK_PROD_ALERTS_WEBHOOK_URL }}
          NOTIFY_TYPE: mirrord_assets
          TAG: ${{ steps.check.outputs.tag }}
          HTML_URL: ${{ steps.check.outputs.html_url }}
          ERROR: ${{ steps.check.outputs.error }}
          MISSING_REQUIRED: ${{ steps.check.outputs.missing_required }}
        run: node .github/workflows/scripts/slack_notify.js

      - name: Notify Slack on OPTIONAL Windows asset warning
        if: steps.check.outputs.ok == 'true' && steps.check.outputs.missing_optional != ''
        shell: bash
        env:
          SLACK_PROD_ALERTS_WEBHOOK_URL: ${{ secrets.SLACK_PROD_ALERTS_WEBHOOK_URL }}
          NOTIFY_TYPE: mirrord_assets_optional
          TAG: ${{ steps.check.outputs.tag }}
          HTML_URL: ${{ steps.check.outputs.html_url }}
          MISSING_OPTIONAL: ${{ steps.check.outputs.missing_optional }}
        run: node .github/workflows/scripts/slack_notify.js

      - name: Log success
        if: steps.check.outputs.ok == 'true' && steps.check.outputs.missing_optional == ''
        shell: bash
        run: |
          echo "✅ Release monitor: all required and optional assets are present on latest release."


  # ============================================================
  # 2) Check latest Operator Release (Docker Image only)
  # ============================================================
  check_operator_release:
    runs-on: ubuntu-24.04
    outputs:
      tag: ${{ steps.check.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check latest Operator Release and Docker Image
        id: check
        uses: actions/github-script@v7
        env:
          OPERATOR_MONITOR_TOKEN: ${{ secrets.OPERATOR_MONITOR_TOKEN }}
          CHECK_TYPE: operator
        with:
          script: |
            const script = require('./.github/workflows/scripts/check_release.js');
            await script({ github, context, core, exec });

      - name: Notify Slack on FAILURE
        if: steps.check.outputs.ok != 'true'
        shell: bash
        env:
          SLACK_PROD_ALERTS_WEBHOOK_URL: ${{ secrets.SLACK_PROD_ALERTS_WEBHOOK_URL }}
          NOTIFY_TYPE: operator_assets
          TAG: ${{ steps.check.outputs.tag }}
          ERROR: ${{ steps.check.outputs.error }}
        run: node .github/workflows/scripts/slack_notify.js

      - name: Log success
        if: steps.check.outputs.ok == 'true'
        shell: bash
        run: |
          echo "✅ Operator Release monitor: Docker image present for latest release."


  # ============================================================
  # 2) Install-path tests (curl|bash + Homebrew) on Linux & macOS
  # ============================================================
  test_install_paths:
    needs: check_latest_release
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Show env + release info
        shell: bash
        run: |
          echo "Running on OS: ${{ runner.os }}"
          echo "Latest tag from monitor: '${{ needs.check_latest_release.outputs.tag }}'"
          echo "Release URL from monitor: '${{ needs.check_latest_release.outputs.html_url }}'"

      - name: Test curl|bash installer
        id: curl
        shell: bash
        run: node .github/workflows/scripts/test_install_script.js

      - name: Remove mirrord binary between installers
        shell: bash
        run: |
          set -euo pipefail
          BIN="$(command -v mirrord || true)"
          if [ -n "$BIN" ]; then
            echo "Removing mirrord binary at: $BIN"
            rm -f "$BIN" || true
          else
            echo "No mirrord binary found to remove."
          fi
          hash -r || true

      - name: Install Homebrew on Linux if missing
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail

          if command -v brew >/dev/null 2>&1; then
            echo "Homebrew already installed on this Linux runner."
          else
            echo "Installing Homebrew on Linux (non-interactive)..."
            NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi

          # Ensure Linuxbrew is on PATH for subsequent steps
          if [ -d "/home/linuxbrew/.linuxbrew/bin" ]; then
            echo "Adding Linuxbrew to PATH"
            {
              echo "HOMEBREW_PREFIX=/home/linuxbrew/.linuxbrew"
              echo "HOMEBREW_NO_AUTO_UPDATE=1"
              echo "PATH=/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:$PATH"
            } >> "$GITHUB_ENV"
          fi

      - name: Test Homebrew install (Linux + macOS)
        id: brew
        shell: bash
        run: |
          set -euo pipefail

          if ! command -v brew >/dev/null 2>&1; then
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "error=Homebrew (brew) is not installed on this runner." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Installing mirrord via Homebrew: metalbear-co/mirrord/mirrord"
          if ! brew install metalbear-co/mirrord/mirrord >/tmp/brew_install.log 2>&1; then
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "error=brew install metalbear-co/mirrord/mirrord failed. See logs in this step." >> "$GITHUB_OUTPUT"
            echo "----- brew output -----"
            cat /tmp/brew_install.log || true
            exit 0
          fi

          if ! command -v mirrord >/dev/null 2>&1; then
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "error=mirrord not on PATH after brew install." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! mirrord --version >/tmp/mirrord_version_brew.log 2>&1; then
            echo "ok=false" >> "$GITHUB_OUTPUT"
            echo "error=mirrord --version failed after brew install." >> "$GITHUB_OUTPUT"
            echo "----- mirrord --version output (brew) -----"
            cat /tmp/mirrord_version_brew.log || true
            exit 0
          fi

          echo "brew install succeeded. Version:"
          cat /tmp/mirrord_version_brew.log || true

          echo "ok=true" >> "$GITHUB_OUTPUT"
          echo "error=" >> "$GITHUB_OUTPUT"

      - name: Notify Slack on install failures
        if: steps.curl.outputs.ok != 'true' || steps.brew.outputs.ok != 'true'
        shell: bash
        env:
          SLACK_PROD_ALERTS_WEBHOOK_URL: ${{ secrets.SLACK_PROD_ALERTS_WEBHOOK_URL }}
          NOTIFY_TYPE: install_failure
          BREW_OK: ${{ steps.brew.outputs.ok }}
          BREW_ERROR: ${{ steps.brew.outputs.error }}
          CURL_OK: ${{ steps.curl.outputs.ok }}
          CURL_ERROR: ${{ steps.curl.outputs.error }}
          TAG: ${{ needs.check_latest_release.outputs.tag }}
          HTML_URL: ${{ needs.check_latest_release.outputs.html_url }}
          OS: ${{ runner.os }}
        run: node .github/workflows/scripts/slack_notify.js

      - name: Log install success
        if: steps.curl.outputs.ok == 'true' && steps.brew.outputs.ok == 'true'
        shell: bash
        run: |
          echo "✅ Install monitor: curl and Homebrew installers succeeded on ${{ runner.os }}."


  # ============================================================
  # 3) Version endpoint vs GitHub release download URLs
  # ============================================================
  check_version_endpoint:
    needs: check_latest_release
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Check version endpoint vs release download URLs
        id: version
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/workflows/scripts/check_version_endpoint.js');
            await script({ github, context, core, exec });

      - name: Notify Slack on version API / URL mismatch
        if: steps.version.outputs.ok != 'true'
        shell: bash
        env:
          SLACK_PROD_ALERTS_WEBHOOK_URL: ${{ secrets.SLACK_PROD_ALERTS_WEBHOOK_URL }}
          NOTIFY_TYPE: version_mismatch
          TAG: ${{ needs.check_latest_release.outputs.tag }}
          HTML_URL: ${{ needs.check_latest_release.outputs.html_url }}
          VER: ${{ steps.version.outputs.version }}
          ERROR: ${{ steps.version.outputs.error }}
          MISSING_URLS: ${{ steps.version.outputs.missing_urls }}
        run: node .github/workflows/scripts/slack_notify.js

      - name: Log version endpoint success
        if: steps.version.outputs.ok == 'true'
        shell: bash
        run: |
          echo "✅ Version endpoint check passed. version.mirrord.dev -> ${{ steps.version.outputs.version }}"

          